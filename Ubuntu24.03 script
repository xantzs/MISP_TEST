#!/bin/bash
# ============================================================
#  OctaSec | MISP 2.5 Full Installation Demo (Ubuntu 24.04)
#  Author: xantzs
# ============================================================

# Your host IP
MISP_HOST="172.25.33.10"
ADMIN_EMAIL="admin@admin.test"
ADMIN_PASSWORD="X@ntzs1842003"  # Please change this!

echo "=== [1/10] Updating system and installing prerequisites ==="
sudo apt update && sudo apt upgrade -y
sudo apt install -y git curl unzip gnupg-agent software-properties-common

# 🧱 Creating dedicated MISP user
echo "=== [2/10] Creating user misp ==="
sudo adduser misp --gecos "MISP,,," --disabled-password
echo "misp:OctaSec123!" | sudo chpasswd
sudo usermod -aG sudo,staff,www-data misp

# 🧩 Installing MISP
echo "=== [3/10] Downloading and running official MISP 2.5 installer ==="
sudo -i -u misp bash << 'EOF'
cd /tmp
wget --no-cache -O INSTALL.sh https://raw.githubusercontent.com/MISP/MISP/2.5/INSTALL/INSTALL.ubuntu2404.sh
chmod +x INSTALL.sh
sudo bash INSTALL.sh
EOF

# 🌐 Configuring BaseURL with your IP only (no domain)
echo "=== [4/10] Configuring BaseURL with IP address ==="
sudo -u www-data /var/www/MISP/app/Console/cake Admin setSetting MISP.baseurl "https://$MISP_HOST"

# 🔧 Configure Apache to listen on your IP
echo "=== [4.5/10] Configuring Apache for your IP ==="
sudo sed -i "s/ServerName localhost/ServerName $MISP_HOST/g" /etc/apache2/sites-available/misp.conf
sudo sed -i "s/ServerName localhost/ServerName $MISP_HOST/g" /etc/apache2/sites-available/misp-ssl.conf 2>/dev/null || true

# Remove any domain entries from hosts file to ensure IP access
sudo sed -i '/misp.local/d' /etc/hosts

# 🧩 Enabling SSL
echo "=== [5/10] Enabling Apache SSL ==="
sudo a2enmod ssl
sudo a2ensite default-ssl || true
sudo a2ensite misp-ssl.conf || sudo a2ensite misp.conf
sudo systemctl reload apache2

# 🔐 Password policy adjustment
echo "=== [6/10] Adjusting password policy for demo ==="
sudo -u www-data /var/www/MISP/app/Console/cake Admin setSetting "Security.password_policy_length" 8
sudo -u www-data /var/www/MISP/app/Console/cake Admin setSetting "Security.password_policy_complexity" "^(?=.{8,}).*$"

# 🔑 Reset admin password
echo "=== [7/10] Resetting admin password ==="
sudo -u www-data /var/www/MISP/app/Console/cake user list
sudo -u www-data /var/www/MISP/app/Console/cake Password "$ADMIN_EMAIL" "$ADMIN_PASSWORD"

# 📡 Loading feeds
echo "=== [8/10] Enabling default feeds ==="
sudo -u www-data /var/www/MISP/app/Console/cake Server cacheFeed 1
sudo -u www-data /var/www/MISP/app/Console/cake Server fetchFeed 1

# 📊 Installing Dashboard (optional)
echo "=== [9/10] Installing MISP Dashboard (optional) ==="
sudo apt install -y redis-server python3-venv python3-pip
cd /var/www
sudo git clone https://github.com/MISP/misp-dashboard.git
sudo chown -R www-data:www-data misp-dashboard
cd misp-dashboard
python3 -m venv venv
./venv/bin/pip install -U pip wheel
./venv/bin/pip install -r requirements.txt
sudo tee /etc/systemd/system/misp-dashboard.service >/dev/null <<'UNIT'
[Unit]
Description=MISP Dashboard
After=network.target redis-server.service

[Service]
User=www-data
Group=www-data
WorkingDirectory=/var/www/misp-dashboard
ExecStart=/var/www/misp-dashboard/venv/bin/python3 /var/www/misp-dashboard/app.py
Restart=always

[Install]
WantedBy=multi-user.target
UNIT
sudo systemctl daemon-reload
sudo systemctl enable --now misp-dashboard

# 🧠 Restarting services
echo "=== [10/10] Restarting Apache ==="
sudo systemctl restart apache2

# ✅ Summary
echo "=============================================================="
echo "✅ MISP installation complete!"
echo "🌐 Access: https://$MISP_HOST"
echo "👤 Username: $ADMIN_EMAIL"
echo "🔑 Password: $ADMIN_PASSWORD"
echo "=============================================================="
echo "⚠️  SECURITY NOTES:"
echo "⚠️  1. Change the default password immediately!"
echo "⚠️  2. Configure firewall properly"
echo "⚠️  3. You may see SSL certificate warning - this is normal for IP access"
echo "⚠️  4. Regular security updates required"
echo "=============================================================="
